<!doctype html>
<html lang="en-us">
<head>
<!--****************************************************************************
**  Header / Styles                                                          |||
*****************************************************************************-->
<title>CDECL</title>
<meta charset="UTF-8" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
</meta>
<style>

/*
 * Sets everythings style to be the same.  I'm not sure why the CSS default
 * values confuse me so much, but they never act how I expect and usually I
 * spend more time googling and fiddling than I'd like.
 */

* {
    display:                flex;
    flex-grow:              inherit;
    align-items:            stretch;
    justify-content:        inherit;
    flex-direction:         inherit;

    margin:                 0ch;
    border:                 none;
    border-width:           0ch;
    padding:                0ch;

    font-family:            monospace, monospace;
    font-size:              12pt;
    text-align              justify;

    background-color:       red;
    color:                  red;

    pointer-events:         auto;
}

pre {
    white-space:            pre-wrap;
}

head, title, style, script {
    display:                none;
}

p {
    display:                block;
}

.layer {
    position:               fixed;
    top:                    0ch;
    left:                   0ch;
    height:                 100vh;
    width:                  100vw;
}

.button {
    margin:                 2ch 1ch 2ch 1ch;
    padding:                0ch 1ch 0ch 1ch;
}

.bordered {
    border:                 solid;
    border-width:           1ch;
}

.textarea {
    margin:                 2ch 1ch 2ch 1ch;
    padding:                0ch 0ch 0ch 0ch;
    overflow:               scroll;
}

.htmlarea {
    display:                initial;
    overflow:               scroll;
}

/* smaller borders on smaller displays */
@media (max-device-width: 768px) {
    .bordered {
        border-width:       0.2ch;
    }
    .button {
        padding:            0.2ch;
        margin:             0.2ch;
    }

    .textarea {
        margin:             0.2ch;
        padding:            0.2ch;
    }
}

/* visibility / color modifiers */

.hidden {
    display:                none;
}

.floating {
    background-color:       transparent;
    color:                  transparent;

    /* allows clicking through a transparent div */
    pointer-events:         none;
}

.background {
    background-color:       black;
    color:                  white;
}

.info {
    background-color:       blue;
    color:                  white;
}

.error {
    background-color:       red;
    color:                  white;
}

.warn {
    background-color:       yellow;
    color:                  white;
}

.run {
    background-color:       green;
    color:                  white;
}

.in {
    background-color:       #6b5b95;
    color:                  white;
}

.out {
    background-color:       #d64161;
    color:                  white;
}

/* size / alignment modifiers */

#io_layer {
    flex-direction:         row;
    flex-grow:              1;
}

#controls_layer {
    align-items:            flex-end;
    justify-content:        flex-end;
}

#info_layer {
    align-items:            center;
    justify-content:        center;
}

#info {
    align-items:            flex-start;
    justify-content:        flex-start;
    width:                  75vw;
    height:                 75vh;
}

@media (max-device-width: 768px) {
    #io_layer {
        flex-direction:     column;
    }
    #input {
        max-height:         13ch;
    }
}

</style>
<!--****************************************************************************
**  HTML Body                                                                |||
*****************************************************************************-->
</head>

<body>

    <div class="background layer" id="io_layer">
        <textarea class="in  bordered textarea" id="input"></textarea>
        <textarea class="out bordered textarea" id="output"></textarea>
    </div>


    <div class="floating layer" id="info_layer">
        <div class="bordered info htmlarea" id="info"></div>
    </div>

    <div class="floating layer" id="controls_layer">
        <button class="hidden bordered in button" onclick="print_input()">Print</button>
        <button class="hidden bordered in button" onclick="save_input()">Save</button>
        <button class="hidden bordered out button" onclick="print_output()">Print</button>
        <button class="hidden bordered out button" onclick="save_output()">Save</button>
        <button class="hidden bordered run button" id="run_button">Run</button>
        <button class="info bordered button" onclick="toggle_info()">Info</button>
    </div>
</body>

<!--****************************************************************************
**  Javascript                                                               |||
*****************************************************************************-->

<script type="text/javascript" src="defines.js"></script>

<script type='text/javascript'>

// Haskell-esque partial application
const ap = function() {
    var outer = arguments;
    return function() {
        var inner = arguments;
        var args  = [];
        for (i=1; i<outer.length; i++) args.push(outer[i]);
        for (i=0; i<inner.length; i++) args.push(inner[i]);
        outer[0].apply(null, args);
    }
}
const infoElement   = document.getElementById('info');
const infoLayer     = document.getElementById('info_layer');
const outputElement = document.getElementById('output');
const inputElement  = document.getElementById('input');
const runButton     = document.getElementById('run_button');

const toggle_info = function() {
    if (infoLayer.className == "hidden") {
        infoLayer.className = "floating layer";
    } else {
        infoLayer.className = "hidden";
    }
}

const log = function(color, text) {
    var text = (Array.from(arguments)).slice(1).join(' ');
    var p = '<p class="' + color + '">'
    if (!arguments[2]) {
        text += 'done';
        setTimeout(toggle_info, 1000);
    }

    infoElement.innerHTML += p + text.toLowerCase() + "...</p>";
};

const console = {
    log   : ap(log, 'run',   'console.log:    '),
    info  : ap(log, 'info',  'console.info:   '),
    warn  : ap(log, 'warn',  'console.warn:   '),
    error : ap(log, 'error', 'console.error:  '),
    depend: ap(log, 'info',  'console.info:   ','preparing dependency id#'),
};

const reset = function() {
    inputElement.value    = '';
    outputElement.value   = '';
    infoElement.innerHTML = '';
    outputElement.value += helpContents;
    infoElement.innerHTML += '<pre class="info">' + aboutContents + '</pre>';
}

const print_output = function() {
    outputElement.value = FS.readFile("/out", { encoding: 'utf8' });
}

const print_input = function() {
    inputElement.value = FS.readFile("/in", { encoding: 'utf8' });
}

const save_input = function(x) {
    var input = x ? x : inputElement.value;
    FS.writeFile('/in', input, {flags:'w'});
}

const save_output = function(x) {
    var output = x ? x : outputElement.value;
    FS.writeFile('/out', output, {flags:'w'});
}

const run_function = function(fun) {
    save_input(inputElement.value + '\n');
    fun();
    print_output();
}

</script>

<script type='text/javascript'>
var Module = {};
Module.setStatus = console.info;
Module.printErr = console.error;
Module.monitorRunDependencies = console.depend;
Module.preRun = [];
Module.postRun = [
    function () {
        inputElement.oninput = ap(run_function, Module.asm['_cdecl_function']);
        runButton.onclick = ap(run_function, Module.asm['_cdecl_function']);
    }
];

reset();

</script>

<script async type="text/javascript" src="main.js"></script>

</html>

